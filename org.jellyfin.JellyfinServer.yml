id: org.jellyfin.JellyfinServer
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.dotnet8
  - org.freedesktop.Sdk.Extension.node20
  - org.freedesktop.Sdk.Extension.llvm18
separate-locales: false
command: org.jellyfin.JellyfinServer.sh

cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /lib/*.la
  - /lib/*.a
  - /man
  - /share/cmake
  - /share/doc
  - /share/ffmpeg
  - /share/info
  - /share/man
  - /share/pkgconfig
  - /share/vpl/examples

finish-args:
  - --device=dri
  - --filesystem=home/Jellyfin Server Media:create
  - --filesystem=/media:ro
  - --filesystem=/mnt:ro
  - --filesystem=/run/media:ro
  - --share=network
  - --env=PATH=/app/extensions/bin:/app/bin:/usr/bin
  - --env=LD_LIBRARY_PATH=/app/extensions/lib:/app/lib
  # - --device=all # Needed for v4l2m2m
  # - --filesystem=home:ro
  # - --filesystem=host:ro
  # - --filesystem=xdg-download:ro
  # - --filesystem=xdg-music:ro
  # - --filesystem=xdg-pictures:ro
  # - --filesystem=xdg-videos:ro

add-extensions:
  org.jellyfin.JellyfinServer.Plugin:
    version: stable
    directory: extensions
    add-ld-path: lib
    merge-dirs: lib;bin;OpenCL;
    subdirectories: true
    no-autodownload: true
    autodelete: true

modules:
  - shared-modules/linux-audio/fftw3f.json

  - name: ocl-icd
    build-options:
      arch:
        x86_64:
          config-opts:
            - --enable-custom-vendordir=/usr/lib/x86_64-linux-gnu/GL/OpenCL/vendors
        aarch64:
          config-opts:
            - --enable-custom-vendordir=/usr/lib/aarch64-linux-gnu/GL/OpenCL/vendors
    config-opts:
      - --enable-official-khronos-headers
      - --disable-update-database
    sources:
      - type: archive
        url: https://deb.debian.org/debian/pool/main/o/ocl-icd/ocl-icd_2.3.1.orig.tar.gz
        sha256: a32b67c2d52ffbaf490be9fc18b46428ab807ab11eff7664d7ff75e06cfafd6d
        x-checker-data:
          type: html
          url: https://packages.debian.org/source/bookworm/ocl-icd
          version-pattern: ocl-icd \((\d+\.\d+\.\d+)
          url-template: https://deb.debian.org/debian/pool/main/o/ocl-icd/ocl-icd_$version.orig.tar.gz
      - type: archive
        url: https://deb.debian.org/debian/pool/main/o/ocl-icd/ocl-icd_2.3.1-1.debian.tar.xz
        sha256: eed9c271ebf0c7045a00f4d11f960529cd3c4860300daf5fb806a7af3c228ee7
        dest: debs
        x-checker-data:
          type: html
          url: https://packages.debian.org/source/bookworm/ocl-icd
          version-pattern: ocl-icd \(([^\)]+)\)
          url-template: https://deb.debian.org/debian/pool/main/o/ocl-icd/ocl-icd_$version.debian.tar.xz
      - type: shell
        commands:
          - for p in $(cat debs/patches/series); do if [[ $p != "#"* ]]; then patch
            -Np1 -i "debs/patches/$p" -d .; fi; done
    modules:
      - name: khronos-opencl-headers
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://deb.debian.org/debian/pool/main/k/khronos-opencl-headers/khronos-opencl-headers_3.0~2023.02.06.orig.tar.gz
            sha256: 464d1b04a5e185739065b2d86e4cebf02c154c416d63e6067a5060d7c053c79a
            x-checker-data:
              type: html
              url: https://packages.debian.org/source/bookworm/khronos-opencl-headers
              version-pattern: khronos-opencl-headers \((\d+\.\d+~\d+\.\d+\.\d+)
              url-template: https://deb.debian.org/debian/pool/main/k/khronos-opencl-headers/khronos-opencl-headers_$version.orig.tar.gz
          - type: archive
            url: https://deb.debian.org/debian/pool/main/k/khronos-opencl-headers/khronos-opencl-headers_3.0~2023.02.06-1.debian.tar.xz
            sha256: 3b935732ae4e17ac27512d97a1be287ba245b3ba0840d6a1a66e2ba4a7b2532c
            dest: debs
            x-checker-data:
              type: html
              url: https://packages.debian.org/source/bookworm/khronos-opencl-headers
              version-pattern: khronos-opencl-headers \(([^\)]+)\)
              url-template: https://deb.debian.org/debian/pool/main/k/khronos-opencl-headers/khronos-opencl-headers_$version.debian.tar.xz
          - type: shell
            commands:
              - for p in $(cat debs/patches/series); do if [[ $p != "#"* ]]; then patch
                -Np1 -i "debs/patches/$p" -d .; fi; done

  - name: intel-mediasdk
    only-arches:
      - x86_64
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SAMPLES=OFF
      - -DBUILD_TUTORIALS=OFF
      - -DENABLE_X11=OFF
    sources:
      - type: archive
        url: https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/intel-mediasdk/22.5.4-1ubuntu1/intel-mediasdk_22.5.4.orig.tar.gz
        sha256: 0eb04409a226da6e752576d60c46a3ec969ddfe03042897088367392207c7ab3
        x-checker-data:
          type: html
          url: https://launchpad.net/ubuntu/+source/intel-mediasdk
          version-pattern: intel-mediasdk \((\d+\.\d+\.\d+)
          url-template: https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/intel-mediasdk/$version-1ubuntu1/intel-mediasdk_$version.orig.tar.gz
      - type: archive
        url: https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/intel-mediasdk/22.5.4-1ubuntu1/intel-mediasdk_22.5.4-1ubuntu1.debian.tar.xz
        sha256: 3f414418cc382efd6b2e5304f60ee91b7a9d45c3e98f0fb3d56fb9801ce2e054
        dest: debs
        x-checker-data:
          type: html
          url: https://launchpad.net/ubuntu/+source/intel-mediasdk
          version-pattern: intel-mediasdk \(([^\)]+)\)
          url-template: https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/intel-mediasdk/$version-1ubuntu1/intel-mediasdk_$version-1ubuntu1.debian.tar.xz
      - type: shell
        commands:
          - for p in $(cat debs/patches/series); do if [[ $p != "#"* ]]; then patch
            -Np1 -i "debs/patches/$p" -d .; fi; done

  - name: onevpl
    only-arches:
      - x86_64
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_TOOLS=OFF
      - -DBUILD_TESTS=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DINSTALL_EXAMPLE_CODE=OFF
    sources:
      - type: git
        url: https://github.com/intel/libvpl.git
        commit: 0c13c410095764799afea0cf645bd896378579b8
        tag: v2.12.0
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: onevpl-intel-gpu
    only-arches:
      - x86_64
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_TOOLS=OFF
      - -DBUILD_TESTS=OFF
    sources:
      - type: git
        url: https://github.com/intel/vpl-gpu-rt.git
        commit: e0b981d1bf8ca4f9d346089d530cc149c09e10df
        # NOTE: Pick the latest release, not the latest tag. The latter might not compile.
        tag: intel-onevpl-24.2.5 
        x-checker-data:
          type: git
          tag-pattern: ^intel-onevpl-([\d.]+)$

  - name: chromaprint
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TOOLS=OFF
      - -DBUILD_TESTS=OFF
      - -DFFT_LIB=fftw3f
    sources:
      - type: git
        url: https://github.com/acoustid/chromaprint.git
        commit: 5c3be6803856f25b11d1d704bac56e733b4fc997
        # NOTE: Pick the latest release, not the latest tag. The latter might not compile.
        tag: v1.5.1 
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: libopenmpt
    buildsystem: simple
    build-commands:
      #- ./configure
      - make -j$FLATPAK_BUILDER_N_JOBS PREFIX=$FLATPAK_DEST install
    config-opts:
      - --disable-examples
      - --disable-openmpt123
      - --disable-static
      - --disable-tests
      - --without-portaudio
      - --without-portaudiocpp
    sources:
      - type: git
        url: https://github.com/OpenMPT/openmpt.git
        commit: 6d49a8e92a78586e44eafd426042c368591bf48e
        tag: libopenmpt-0.7.9 
        x-checker-data:
          type: git
          tag-pattern: ^libopenmpt-([\d.]+)$

  - name: libass
    config-opts:
      - --enable-shared
      - --disable-static
      - --with-pic
    sources:
      - type: git
        url: https://github.com/libass/libass.git
        commit: e46aedea0a0d17da4c4ef49d84b94a7994664ab5
        tag: 0.17.3
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$

  - name: libbluray
    config-opts:
      - --enable-shared
      - --disable-static
      - --with-pic
      - --disable-doxygen-doc
      - --disable-doxygen-dot
      - --disable-doxygen-html
      - --disable-doxygen-ps
      - --disable-doxygen-pdf
      - --disable-examples
      - --disable-bdjava-jar
    sources:
      - type: git
        url: https://code.videolan.org/videolan/libbluray.git
        commit: bb5bc108ec695889855f06df338958004ff289ef
        tag: 1.3.4
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$

  - name: shaderc
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DSHADERC_SKIP_TESTS=ON
      - -DSHADERC_SKIP_EXAMPLES=ON
      - -DSHADERC_SKIP_COPYRIGHT_CHECK=ON
      - -DENABLE_EXCEPTIONS=ON
      - -DENABLE_CTEST=OFF
      - -DENABLE_GLSLANG_BINARIES=OFF
      - -DSPIRV_SKIP_EXECUTABLES=ON
      - -DSPIRV_TOOLS_BUILD_STATIC=OFF
      - -DBUILD_SHARED_LIBS=ON
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/google/shaderc.git
        commit: 47a9387ef5b3600d30d84c71ec77a59dc7db46fa
        tag: v2024.1
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: git
        url: https://github.com/KhronosGroup/SPIRV-Tools.git
        commit: 0cfe9e7219148716dfd30b37f4d21753f098707a
        dest: third_party/spirv-tools
        tag: v2024.3
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: git
        url: https://github.com/KhronosGroup/SPIRV-Headers.git
        commit: 2acb319af38d43be3ea76bfabf3998e5281d8d12
        dest: third_party/spirv-headers
        tag: vulkan-sdk-1.3.290.0
        x-checker-data:
          type: git
          tag-pattern: ^vulkan-sdk-([\d.]+)$
      - type: git
        url: https://github.com/KhronosGroup/glslang.git
        commit: fa9c3deb49e035a8abcabe366f26aac010f6cbfb
        dest: third_party/glslang
        tag: vulkan-sdk-1.3.290.0
        x-checker-data:
          type: git
          tag-pattern: ^vulkan-sdk-([\d.]+)$

  - name: libplacebo
    buildsystem: meson
    config-opts:
      - --buildtype=release
      - --default-library=shared
      - -Dvulkan=enabled
      # - -Dvk-proc-addr=disabled
      - -Dshaderc=enabled
      - -Dglslang=disabled
      - -Ddemos=false
      - -Dtests=false
      - -Dbench=false
      - -Dfuzz=false
    cleanup:
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/haasn/libplacebo.git
        commit: 1fd3c7bde7b943fe8985c893310b5269a09b46c5
        tag: v7.349.0
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: git
        url: https://github.com/KhronosGroup/Vulkan-Loader.git
        commit: 40b8e6eeead809a62c708cb48fdd9f8f2eab3f15
        tag: vulkan-sdk-1.3.290.0
        dest: tmp/vulkan-loader
        x-checker-data:
          type: git
          tag-pattern: ^vulkan-sdk-([\d.]+)$
      # Already included as a submodule: glad, jinja, markupsafe

  - name: numactl
    #buildsystem: autotools
    buildsystem: simple
    build-commands:
      - ./autogen.sh
      - ./configure --prefix $FLATPAK_DEST
      - make -j$FLATPAK_BUILDER_N_JOBS PREFIX=$FLATPAK_DEST install
    cleanup:
      - /bin
    sources:
      - type: git
        url: https://github.com/numactl/numactl.git
        commit: 3871b1c42fc71bceadafd745d2eff5dddfc2d67e
        tag: v2.0.18
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: x264
    config-opts:
      - --disable-cli
      - --enable-shared
      - --disable-static
      - --enable-pic
      - --disable-lavf
      - --disable-swscale
    sources:
      - type: git
        #url: https://code.videolan.org/videolan/x264.git
        # NOTE: Unoffical, repo has tags and is therefore better trackable.
        url: https://github.com/ShiftMediaProject/x264.git
        commit: 64a4204c3da98c7b02fcafb20bc4bf515dcd3bf8
        tag: 0.164.r3191
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+).r\d$

  - name: x265-8bit
    buildsystem: cmake-ninja
    builddir: true
    subdir: source
    build-options:
      arch:
        x86_64:
          config-opts:
            - -DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy
        aarch64:
          append-path: /usr/lib/sdk/llvm18/bin
          prepend-ld-library-path: /usr/lib/sdk/llvm18/lib
          env:
            CC: clang
            CXX: clang++
          config-opts:
            - -DENABLE_ASSEMBLY=OFF
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DENABLE_CLI=OFF
      - -DENABLE_HDR10_PLUS=ON
      - -DENABLE_PIC=ON
      - -DENABLE_SHARED=ON
      - -DEXTRA_LIB=x265_main10.a;x265_main12.a
      - -DEXTRA_LINK_FLAGS=-L .
      - -DLINKED_10BIT=ON
      - -DLINKED_12BIT=ON
    sources:
      - type: git
        url: https://bitbucket.org/multicoreware/x265_git.git
        commit: aa7f602f7592eddb9d87749be7466da005b556ee
        tag: 3.6
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$
    modules:
      - name: x265-10bit
        buildsystem: cmake-ninja
        builddir: true
        subdir: source
        no-make-install: true
        build-options:
          arch:
            x86_64:
              config-opts:
                - -DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy
            aarch64:
              append-path: /usr/lib/sdk/llvm18/bin
              prepend-ld-library-path: /usr/lib/sdk/llvm18/lib
              env:
                CC: clang
                CXX: clang++
              config-opts:
                - -DENABLE_ASSEMBLY=OFF
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DENABLE_CLI=OFF
          - -DENABLE_HDR10_PLUS=ON
          - -DENABLE_PIC=ON
          - -DENABLE_SHARED=OFF
          - -DEXPORT_C_API=OFF
          - -DHIGH_BIT_DEPTH=ON
        build-commands:
          - install -D libx265.a $FLATPAK_DEST/lib/libx265_main10.a
        sources:
          - type: git
            url: https://bitbucket.org/multicoreware/x265_git.git
            commit: aa7f602f7592eddb9d87749be7466da005b556ee
            tag: 3.6
            x-checker-data:
              type: git
              tag-pattern: ^([\d.]+)$
      - name: x265-12bit
        buildsystem: cmake-ninja
        builddir: true
        subdir: source
        no-make-install: true
        build-options:
          arch:
            x86_64:
              config-opts:
                - -DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy
            aarch64:
              append-path: /usr/lib/sdk/llvm18/bin
              prepend-ld-library-path: /usr/lib/sdk/llvm18/lib
              env:
                CC: clang
                CXX: clang++
              config-opts:
                - -DENABLE_ASSEMBLY=OFF
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DENABLE_CLI=OFF
          - -DENABLE_HDR10_PLUS=ON
          - -DENABLE_PIC=ON
          - -DENABLE_SHARED=OFF
          - -DEXPORT_C_API=OFF
          - -DHIGH_BIT_DEPTH=ON
          - -DMAIN12=ON
        build-commands:
          - install -D libx265.a $FLATPAK_DEST/lib/libx265_main12.a
        sources:
          - type: git
            url: https://bitbucket.org/multicoreware/x265_git.git
            commit: aa7f602f7592eddb9d87749be7466da005b556ee
            tag: 3.6
            x-checker-data:
              type: git
              tag-pattern: ^([\d.]+)$

  - name: zimg
    config-opts:
      - --enable-shared
      - --disable-static
      - --with-pic
    sources:
      - type: git
        url: https://github.com/sekrit-twc/zimg.git
        commit: e5b0de6bebbcbc66732ed5afaafef6b2c7dfef87
        tag: release-3.0.5
        x-checker-data:
          type: git
          tag-pattern: ^release-([\d.]+)$

  - name: zvbi
    # NOTE: Looks like this was for handling a sub-folder that contained the source code.
    #subdir: zvbi-0.2.41
    config-opts:
      - --enable-shared
      - --disable-static
      - --with-pic
      - --without-doxygen
      - --without-x
      - --disable-dvb
      - --disable-bktr
      - --disable-nls
      - --disable-proxy
    sources:
      - type: git
        url: https://github.com/zapping-vbi/zvbi.git
        commit: 3785481f51f41a49e28f2b7f6fd5bd9187d24ae1
        tag: v0.2.42
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: nv-codec-headers
    no-autogen: true
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    cleanup:
      - '*'
    sources:
      - type: git
        url: https://github.com/FFmpeg/nv-codec-headers.git
        commit: f8ae7a49bfef2f99d2c931a791dc3863fda67bf3
        tag: n11.1.5.2 
        x-checker-data:
          type: git
          tag-pattern: ^n([\d.]+)$

  - name: amf
    buildsystem: simple
    build-commands:
      - mkdir -p $FLATPAK_DEST/include
      - mv amf/public/include $FLATPAK_DEST/include/AMF
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/GPUOpen-LibrariesAndSDKs/AMF/archive/refs/tags/v1.4.34.tar.gz
        sha256: a8f8363ee9b89c7fb93fa8cca521f602d5fd2c083382fc14f05c37d952905cc6
        x-checker-data:
          type: anitya
          project-id: 138182
          stable-only: true
          url-template: https://github.com/GPUOpen-LibrariesAndSDKs/AMF/archive/refs/tags/v$version.tar.gz

  - name: svt-av1
    buildsystem: cmake-ninja
    build-options:
      arch:
        x86_64:
          config-opts:
            - -DENABLE_AVX512=ON
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DBUILD_APPS=OFF
    builddir: true
    sources:
      - type: git
        url: https://gitlab.com/AOMediaCodec/SVT-AV1.git
        commit: c949fe4f14fe288a9b2b47aa3e61335422a83645
        tag: v2.1.2 
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: clinfo
    buildsystem: simple
    build-commands:
      - make -j$FLATPAK_BUILDER_N_JOBS PREFIX=$FLATPAK_DEST install
      - chmod 755 $FLATPAK_DEST/bin/clinfo
    sources:
      - type: git
        url: https://github.com/Oblomov/clinfo.git
        commit: 748c3930a9b9cb826e631d77439e2cb8f84f5bcf
        tag: 3.0.23.01.25 
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$

  - name: vulkan-tools
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_CUBE=OFF
      - -DBUILD_ICD=OFF
      - -DCMAKE_BUILD_TYPE=Release
      - -DVULKAN_HEADERS_INSTALL_DIR=/app
      #- -DVOLK_DIR=/app
    sources:
      - type: archive
        url: https://deb.debian.org/debian/pool/main/v/vulkan-tools/vulkan-tools_1.3.239.0+dfsg1.orig.tar.xz
        sha256: faef7f477008b0a57bad21ee2bd791cbb08403a64d6b3eaf29d691a32eb8c592
        x-checker-data:
          type: html
          url: https://packages.debian.org/source/bookworm/vulkan-tools
          version-pattern: vulkan-tools \((\d+\.\d+\.\d+\.\d+)
          url-template: https://deb.debian.org/debian/pool/main/v/vulkan-tools/vulkan-tools_$version+dfsg1.orig.tar.xz
      - type: archive
        url: https://deb.debian.org/debian/pool/main/v/vulkan-tools/vulkan-tools_1.3.239.0+dfsg1-1.debian.tar.xz
        sha256: c5ca62210adab80ecf0e9df732ecfce7854b6b3c5686d8d1738ffca1f92fb516
        dest: debs
        x-checker-data:
          type: html
          url: https://packages.debian.org/source/bookworm/vulkan-tools
          version-pattern: vulkan-tools \(([^\)]+)\)
          url-template: https://deb.debian.org/debian/pool/main/v/vulkan-tools/vulkan-tools_$version.debian.tar.xz
      - type: shell
        commands:
          - for p in $(cat debs/patches/series); do if [[ $p != "#"* ]]; then patch
            -Np1 -i "debs/patches/$p" -d .; fi; done
    modules:
      - name: vulkan-headers
        buildsystem: cmake-ninja
        subdir: vulkan-headers
        sources:
          - type: archive
            url: https://deb.debian.org/debian/pool/main/v/vulkan-loader/vulkan-loader_1.3.239.0.orig.tar.xz
            sha256: 90ca97151d774ea3f00129ad32be03cdfa310215651ceec0cd9fc2d0d1804d86
            x-checker-data:
              type: html
              url: https://packages.debian.org/source/bookworm/vulkan-loader
              version-pattern: vulkan-loader \((\d+\.\d+\.\d+\.\d+)
              url-template: https://deb.debian.org/debian/pool/main/v/vulkan-loader/vulkan-loader_$version.orig.tar.xz
          - type: archive
            url: https://deb.debian.org/debian/pool/main/v/vulkan-loader/vulkan-loader_1.3.239.0-1.debian.tar.xz
            sha256: c38c319e1137549ddea481b811cfb39bca015ddc11876a915ad78c664cb7746e
            dest: debs
            x-checker-data:
              type: html
              url: https://packages.debian.org/source/bookworm/vulkan-loader
              version-pattern: vulkan-loader \(([^\)]+)\)
              url-template: https://deb.debian.org/debian/pool/main/v/vulkan-loader/vulkan-loader_$version.debian.tar.xz
          - type: shell
            commands:
              - for p in $(cat debs/patches/series); do if [[ $p != "#"* ]]; then
                patch -Np1 -i "debs/patches/$p" -d .; fi; done

  - name: jellyfin-ffmpeg
    disabled: false
    build-options:
      append-path: /usr/lib/sdk/llvm18/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm18/lib
      arch:
        x86_64:
          config-opts:
            - --enable-libmfx # intel-mediasdk
    config-opts:
      - --disable-doc
      - --disable-ffplay
      - --disable-libxcb
      - --disable-ptx-compression
      - --disable-sdl2
      - --disable-static
      - --disable-xlib
      - --enable-amf
      - --enable-chromaprint
      - --enable-cuda
      - --enable-cuda-llvm
      - --enable-cuvid
      - --enable-ffnvcodec
      - --enable-gmp
      - --enable-gnutls
      - --enable-gpl
      - --enable-libass
      - --enable-libbluray
      - --enable-libdav1d
      - --enable-libdrm
      - --enable-libfdk-aac
      - --enable-libfontconfig
      - --enable-libfreetype
      - --enable-libfribidi
      - --enable-libmp3lame
      - --enable-libopenmpt
      - --enable-libopus
      - --enable-libplacebo
      - --enable-libshaderc
      - --enable-libsvtav1
      - --enable-libtheora
      - --enable-libvorbis
      - --enable-libvpx
      - --enable-libwebp
      - --enable-libx264
      - --enable-libx265
      - --enable-libzimg
      - --enable-libzvbi
      - --enable-lto
      - --enable-nvdec
      - --enable-nvenc
      - --enable-opencl
      - --enable-shared
      - --enable-vaapi
      - --enable-version3
      - --enable-vulkan
      - --extra-libs=-lfftw3f
      - --extra-version=Jellyfin
      - --target-os=linux
    sources:
      - type: git
        url: https://github.com/jellyfin/jellyfin-ffmpeg.git
        commit: 02b8f47e4e063920403a52dbf196a83e5957b83a
        tag: v6.0.1-8
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)-\d$
          #versions:
          #  <: "6.0"
      - type: shell
        commands:
          - cat debian/patches/*.patch | patch -Np1 -d .

  - name: jellyfin-web
    disabled: false
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node20/bin
    build-commands:
      - npm ci --no-audit --offline --cache=$FLATPAK_BUILDER_BUILDDIR/flatpak-node/npm-cache
      - npm run build:production --offline --cache=$FLATPAK_BUILDER_BUILDDIR/flatpak-node/npm-cache
      - mkdir -p $FLATPAK_DEST/bin/jellyfin-web
      - cp -r dist/* $FLATPAK_DEST/bin/jellyfin-web
    sources:
      - npm-generated-sources.json
      - type: git
        url: https://github.com/jellyfin/jellyfin-web.git
        commit: 6f203b9d1d0010ed16c6185245e612edcc1f863f
        tag: v10.9.11
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: jellyfin
    disabled: false
    buildsystem: simple
    build-options:
      append-ld-library-path: /usr/lib/sdk/dotnet8/lib
      append-path: /usr/lib/sdk/dotnet8/bin
      append-pkg-config-path: /usr/lib/sdk/dotnet8/lib/pkgconfig
      env:
        DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
      arch:
        x86_64:
          env:
            RUNTIME: linux-x64
        aarch64:
          env:
            RUNTIME: linux-arm64
    build-commands:
      - install -D $FLATPAK_ID.sh $FLATPAK_DEST/bin/$FLATPAK_ID.sh
      - install -D $FLATPAK_ID.metainfo.xml $FLATPAK_DEST/share/metainfo/$FLATPAK_ID.metainfo.xml
      - install -D $FLATPAK_ID.desktop $FLATPAK_DEST/share/applications/$FLATPAK_ID.desktop
      - install -D $FLATPAK_ID-128.png $FLATPAK_DEST/share/icons/hicolor/128x128/apps/$FLATPAK_ID.png
      - mkdir -p $FLATPAK_DEST/bin
      - mkdir -p $FLATPAK_DEST/extensions
      - dotnet publish -c Release --source ./nuget-sources --output="$FLATPAK_DEST/bin"
        --runtime $RUNTIME -p:DebugSymbols=false -p:DebugType=none --self-contained
        true Jellyfin.Server/Jellyfin.Server.csproj
    sources:
      - nuget-generated-sources-x64.json
      - nuget-generated-sources-arm64.json
      - type: git
        url: https://github.com/jellyfin/jellyfin.git
        commit: 7bbdfc0d4943b1823d82cb85795a707a6e3a9b4d
        tag: v10.9.11
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: file
        path: org.jellyfin.JellyfinServer.metainfo.xml
      - type: file
        path: org.jellyfin.JellyfinServer.desktop
      - type: file
        path: org.jellyfin.JellyfinServer-128.png
      - type: file
        path: org.jellyfin.JellyfinServer.sh
